# 实现按需渲染 (On-Demand Rendering)

为了优化性能，将把引擎的渲染循环从"死循环"改为"按需触发"。只有当场景发生变化（如交互、纹理加载完成、属性变更）时，才请求下一帧渲染。

## 实施计划

1.  **修改 `src/engine/display/Node.ts`**
    *   添加 `invalidate()` 方法：该方法会向上冒泡调用父节点的 `invalidate()`，直到根节点。
    *   添加 `onInvalidate` 回调属性：用于根节点通知引擎需要重绘。

2.  **修改 `src/engine/Engine.ts`**
    *   移除 `loop()` 中的递归 `requestAnimationFrame`。
    *   实现 `requestRender()` 方法：使用防抖动 (Debounce) 机制，确保同一帧内多次请求只触发一次渲染。
    *   在构造函数中监听 `scene.onInvalidate`，绑定到 `requestRender`。
    *   保留 `loop` 方法作为单帧渲染入口。

3.  **修改 `src/engine/display/Sprite.ts`**
    *   在纹理加载完成的回调中调用 `this.invalidate()`，确保图片加载后自动刷新显示。

4.  **修改 `src/engine/display/TileLayer.ts`**
    *   在瓦片纹理加载完成的回调中调用 `this.invalidate()`，确保地图瓦片加载后显示。

5.  **修改 `src/engine/events/InteractionManager.ts`**
    *   在所有交互事件（鼠标悬停、按下、拖拽、缩放、平移、框选）改变状态后，主动调用 `this.scene.invalidate()` 或对应节点的 `invalidate()`，触发重绘。

## 预期效果

*   **静止时**：CPU/GPU 占用率大幅降低，不再持续刷新。
*   **交互时**：响应流畅，操作触发重绘。
*   **加载时**：资源加载完成后自动刷新画面。
